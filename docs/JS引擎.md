# JS 引擎

## 前言

在设计naruse之前，作者借鉴了 `kbone` 与  `Taro` 实现了一个简易虚拟DOM树，可以将符合格式的 JSON 字符串转换成小程序的DOM树，现在也可以在项目的早期commit找到其痕迹。

虚拟DOM树存在，这也是naruse能够在小程序实现热更新的根本，有了虚拟DOM树，配合上动态的加载逻辑，就可以实现任意组件的热更新。

然而小程序封禁了`eval` 与 `Function` 等动态执行代码的可能，故只能引入一个JS引擎来补充这最后一环。

虽说是 JS 引擎，但其实就是在 JS 内部中解析，执行 JS 代码，其难度远比把 JS 代码编译成字节码执行的难度要低，这类项目在github里面一抓一大把。

不过在考量了许久之后，最后还是选择自己fork `acorn` 的仓库重写，主要还是因为现在的项目体积是在是太大了。

一个完整ES5的编译器本身在打包后体积已经超过120KB，再配合解释器，体积已经来到了200KB上下。

在这个有着 2M 体积上限，寸金寸土的小程序内只会挤占业务逻辑，同时按照28原则一个引擎中20%的语法被使用的80%以上。

故最后决定 fork 现在主流的 JS 解释器  acorn 删除部分不常用语法，只留下针对与组件业务开发的语法，来达到缩小体积效果，最后也是将JS引擎缩减到 12KB（压缩后）





## 支持语法

虽说删除了一大票的语法，不过配合babel等语法转译工具，还是可以实现95%左右的ES5与部分ES6。

详细支持语法可以查看ES5规范

>  参考：[ES5规范]([ECMAScript5.1中文版 + ECMAScript3 + ECMAScript（合集） (yanhaijing.com)](https://yanhaijing.com/es5/))

因为是在 JS 环境下执行JS代码，关于类型与引用和环境内置执行变量均支持，主要涉及的删改也主要是关于关键字相关的，具体不支持的关键字如下

## 不支持的关键字

| 关键字            | 说明         | 代替                                           |
| ----------------- | ------------ | ---------------------------------------------- |
| 1e3               | 科学数字法   | 请使用完整的数字                               |
| while             | 条件循环语句 | For                                            |
| switch            | 分支语句     | if                                             |
| try catch finally | 错误捕捉     | 暂不支持，可以在使用环境自行注入trycatch等函数 |
| for in/of         | 迭代         | 暂不支持  请用for语句，in用 object.has         |
| async/await       | 异步语法     | 暂不支持  推荐使用Promise的链式调用            |
| const [a,b] = c;  | 数组解构     | 暂不支持                                       |
| >> <<             | 移位运算符   | 暂不支持  /2/2//2/2/2                           |
| With              | 展开环境     | 暂不支持        |
| throw             | 报错语句     | 暂不支持  外部捕捉                     |
| /Reg/             | 正则语法     | 暂不支持  请用new 创建正则对象来用             |

还有其他不支持的语法可以补充
